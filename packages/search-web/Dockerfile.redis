FROM docker.io/searxng/searxng:latest

# Install redis tools for health checks
USER root
RUN apk add --no-cache redis

# Copy configuration
COPY searxng-settings.yml /etc/searxng/settings.yml

# Set environment variables
ENV SEARXNG_BASE_URL=https://localhost:8080
ENV UWSGI_WORKERS=2
ENV UWSGI_THREADS=2
ENV REDIS_URL=redis://redis:6379/0

# Health check that includes Redis connectivity
HEALTHCHECK --interval=30s --timeout=10s --start-period=15s --retries=3 \
    CMD curl -f http://localhost:8080/healthz && \
        redis-cli -u $REDIS_URL ping || exit 1

# Expose port
EXPOSE 8080

# Switch back to searxng user
USER searxng